/**
 * `npm i @temporalio/testing`
 *
 * Testing library for the SDK.
 *
 * [Documentation](https://docs.temporal.io/typescript/testing)
 *
 * @module
 */
/// <reference types="node" />
import 'abort-controller/polyfill';
import events from 'node:events';
import * as activity from '@temporalio/activity';
import { AsyncCompletionClient, Client, ClientOptions, WorkflowClient, WorkflowClientOptions, WorkflowResultOptions } from '@temporalio/client';
import { ActivityFunction, Duration } from '@temporalio/common';
import { NativeConnection } from '@temporalio/worker';
import { EphemeralServer, EphemeralServerConfig, DevServerConfig, TimeSkippingServerConfig } from '@temporalio/core-bridge';
import { Connection, TestService } from './connection';
export { TimeSkippingServerConfig, DevServerConfig, EphemeralServerExecutable } from '@temporalio/core-bridge';
export { EphemeralServerConfig };
export interface TimeSkippingWorkflowClientOptions extends WorkflowClientOptions {
    connection: Connection;
    enableTimeSkipping: boolean;
}
export interface TestEnvClientOptions extends ClientOptions {
    connection: Connection;
    enableTimeSkipping: boolean;
}
/**
 * A client with the exact same API as the "normal" client with 1 exception,
 * When this client waits on a Workflow's result, it will enable time skipping
 * in the test server.
 */
export declare class TimeSkippingWorkflowClient extends WorkflowClient {
    protected readonly testService: TestService;
    protected readonly enableTimeSkipping: boolean;
    constructor(options: TimeSkippingWorkflowClientOptions);
    /**
     * Gets the result of a Workflow execution.
     *
     * @see {@link WorkflowClient.result}
     */
    result<T>(workflowId: string, runId?: string | undefined, opts?: WorkflowResultOptions | undefined): Promise<T>;
}
/**
 * Convenience workflow interceptors
 *
 * Contains a single interceptor for transforming `AssertionError`s into non
 * retryable `ApplicationFailure`s.
 */
export declare const workflowInterceptorModules: string[];
/**
 * Subset of the "normal" client options that are used to create a client for the test environment.
 */
export type ClientOptionsForTestEnv = Omit<ClientOptions, 'namespace' | 'connection'>;
/**
 * Options for {@link TestWorkflowEnvironment.create}
 */
export type TestWorkflowEnvironmentOptions = {
    server: EphemeralServerConfig;
    client?: ClientOptionsForTestEnv;
};
/**
 * Options for {@link TestWorkflowEnvironment.createTimeSkipping}
 */
export type TimeSkippingTestWorkflowEnvironmentOptions = {
    server?: Omit<TimeSkippingServerConfig, 'type'>;
    client?: ClientOptionsForTestEnv;
};
/**
 * Options for {@link TestWorkflowEnvironment.createLocal}
 */
export type LocalTestWorkflowEnvironmentOptions = {
    server?: Omit<DevServerConfig, 'type'>;
    client?: ClientOptionsForTestEnv;
};
export type TestWorkflowEnvironmentOptionsWithDefaults = Required<TestWorkflowEnvironmentOptions>;
/**
 * An execution environment for running Workflow integration tests.
 *
 * Runs an external server.
 * By default, the Java test server is used which supports time skipping.
 */
export declare class TestWorkflowEnvironment {
    readonly options: TestWorkflowEnvironmentOptionsWithDefaults;
    readonly supportsTimeSkipping: boolean;
    protected readonly server: EphemeralServer;
    /**
     * Namespace used in this environment (taken from {@link TestWorkflowEnvironmentOptions})
     */
    readonly namespace?: string;
    /**
     * Get an established {@link Connection} to the ephemeral server
     */
    readonly connection: Connection;
    /**
     * A {@link TestEnvClient} for interacting with the ephemeral server
     */
    readonly client: Client;
    /**
     * An {@link AsyncCompletionClient} for interacting with the test server
     *
     * @deprecated - use `client.activity` instead
     */
    readonly asyncCompletionClient: AsyncCompletionClient;
    /**
     * A {@link TimeSkippingWorkflowClient} for interacting with the test server
     *
     * @deprecated - use `client.workflow` instead
     */
    readonly workflowClient: WorkflowClient;
    /**
     * A {@link NativeConnection} for interacting with the test server.
     *
     * Use this connection when creating Workers for testing.
     */
    readonly nativeConnection: NativeConnection;
    protected constructor(options: TestWorkflowEnvironmentOptionsWithDefaults, supportsTimeSkipping: boolean, server: EphemeralServer, connection: Connection, nativeConnection: NativeConnection, namespace: string | undefined);
    /**
     * Start a time skipping workflow environment.
     *
     * By default, this environment will automatically skip to the next events in time when a workflow handle's `result`
     * is awaited on (which includes {@link WorkflowClient.execute}). Before the result is awaited on, time can be
     * manually skipped forward using {@link sleep}. The currently known time can be obtained via {@link currentTimeMs}.
     *
     * Internally, this environment lazily downloads a test-server binary for the current OS/arch from the [Java SDK
     * releases](https://github.com/temporalio/sdk-java/releases) into the temp directory if it is not already there.
     * Then the executable is started and will be killed when {@link teardown} is called.
     *
     * Users can reuse this environment for testing multiple independent workflows, but not concurrently. Time skipping,
     * which is automatically done when awaiting a workflow result and manually done on sleep, is global to the
     * environment, not to the workflow under test.
     *
     * We highly recommend, running tests serially when using a single environment or creating a separate environment per
     * test.
     *
     * In the future, the test server implementation may be changed to another implementation.
     */
    static createTimeSkipping(opts?: TimeSkippingTestWorkflowEnvironmentOptions): Promise<TestWorkflowEnvironment>;
    /**
     * Start a full Temporal server locally, downloading if necessary.
     *
     * This environment is good for testing full server capabilities, but does not support time skipping like
     * {@link createTimeSkipping} does. {@link supportsTimeSkipping} will always return `false` for this environment.
     * {@link sleep} will sleep the actual amount of time and {@link currentTimeMs} will return the current time.
     *
     * This local environment will be powered by [Temporal CLI](https://github.com/temporalio/cli), which is a
     * self-contained executable for Temporal. By default, Temporal's database will not be persisted to disk, and no UI
     * will be started.
     *
     * The CLI executable will be downloaded and cached to a temporary directory. See
     * {@link LocalTestWorkflowEnvironmentOptions.server.executable.type} if you'd prefer to provide the CLI executable
     * yourself.
     */
    static createLocal(opts?: LocalTestWorkflowEnvironmentOptions): Promise<TestWorkflowEnvironment>;
    /**
     * Create a new test environment
     */
    private static create;
    /**
     * Kill the test server process and close the connection to it
     */
    teardown(): Promise<void>;
    /**
     * Wait for `durationMs` in "server time".
     *
     * This awaits using regular setTimeout in regular environments, or manually skips time in time-skipping environments.
     *
     * Useful for simulating events far into the future like completion of long running activities.
     *
     * **Time skippping**:
     *
     * The time skippping server toggles between skipped time and normal time depending on what it needs to execute.
     *
     * This method is _likely_ to resolve in less than `durationMs` of "real time".
     *
     * @param durationMs number of milliseconds or {@link https://www.npmjs.com/package/ms | ms-formatted string}
     *
     * @example
     *
     * `workflow.ts`
     *
     * ```ts
     * const activities = proxyActivities({ startToCloseTimeout: 2_000_000 });
     *
     * export async function raceActivityAndTimer(): Promise<string> {
     *   return await Promise.race([
     *     wf.sleep(500_000).then(() => 'timer'),
     *     activities.longRunning().then(() => 'activity'),
     *   ]);
     * }
     * ```
     *
     * `test.ts`
     *
     * ```ts
     * const worker = await Worker.create({
     *   connection: testEnv.nativeConnection,
     *   activities: {
     *     async longRunning() {
     *       await testEnv.sleep(1_000_000); // <-- sleep called here
     *     },
     *   },
     *   // ...
     * });
     * ```
     */
    sleep: (durationMs: Duration) => Promise<void>;
    /**
     * Get the current time known to this environment.
     *
     * For non-time-skipping environments this is simply the system time. For time-skipping environments this is whatever
     * time has been skipped to.
     */
    currentTimeMs(): Promise<number>;
}
/**
 * Used as the default activity info for Activities executed in the {@link MockActivityEnvironment}
 */
export declare const defaultActivityInfo: activity.Info;
/**
 * An execution environment for testing Activities.
 *
 * Mocks Activity {@link Context | activity.Context} and exposes hooks for
 * cancellation and heartbeats.
 */
export declare class MockActivityEnvironment extends events.EventEmitter {
    cancel: (reason?: any) => void;
    readonly context: activity.Context;
    constructor(info?: Partial<activity.Info>);
    /**
     * Run a function in Activity Context
     */
    run<P extends any[], R, F extends ActivityFunction<P, R>>(fn: F, ...args: P): Promise<R>;
}
